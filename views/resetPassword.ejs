<% layout("/layouts/boilerplate") %>

<!-- Font Awesome (only once) -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>

<br />
<br />
<div class="row">
  <h1 style="text-align: center">Reset Your Password</h1>

  <div class="col-11 col-md-8 col-lg-4 mx-auto form_body p-4">
    <form
      action="/resetPassword/<%= token %>?_method=PATCH"
      method="POST"
      id="resetPasswordForm"
      class="reset_form"
      novalidate
    >
      <!-- New Password -->
      <div class="mb-3">
        <label for="newPassword" class="form-label">New Password:</label>
        <div class="input-with-icon" style="position: relative">
          <input
            type="password"
            id="newPassword"
            name="password"
            class="form-control"
            placeholder="Enter New Password"
            required
            autocomplete="new-password"
            style="padding-right: 44px"
          />
          <button
            type="button"
            aria-label="Toggle new password visibility"
            class="pw-toggle-btn"
            data-target="newPassword"
            style="
              position: absolute;
              right: 6px;
              top: 50%;
              transform: translateY(-50%);
              border: none;
              background: transparent;
              padding: 6px;
              cursor: pointer;
            "
          >
            <i class="fa-solid fa-eye" id="newPasswordIcon"></i>
          </button>
        </div>
      </div>

      <!-- Confirm Password -->
      <div class="mb-3">
        <label for="confirmPassword" class="form-label"
          >Confirm Password:</label
        >
        <div class="input-with-icon" style="position: relative">
          <input
            type="password"
            id="confirmPassword"
            name="confirmPassword"
            class="form-control"
            placeholder="Confirm New Password"
            required
            autocomplete="new-password"
            style="padding-right: 44px"
          />
          <button
            type="button"
            aria-label="Toggle confirm password visibility"
            class="pw-toggle-btn"
            data-target="confirmPassword"
            style="
              position: absolute;
              right: 6px;
              top: 50%;
              transform: translateY(-50%);
              border: none;
              background: transparent;
              padding: 6px;
              cursor: pointer;
            "
          >
            <i class="fa-solid fa-eye" id="confirmPasswordIcon"></i>
          </button>
        </div>
      </div>

      <div class="d-grid gap-2">
        <button class="btn btn-danger" type="submit">Reset Password</button>
        <a href="/forgot-password" class="btn btn-secondary">cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  // Robust toggler for password visibility.
  // Attaches to every .pw-toggle-btn and toggles the input with id from data-target.
  (function () {
    const toggles = document.querySelectorAll(".pw-toggle-btn");
    if (!toggles || toggles.length === 0) {
      console.warn("No pw-toggle buttons found");
      return;
    }

    toggles.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = btn.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (!input) {
          console.error("Password toggle: target input not found:", targetId);
          return;
        }

        // toggle type
        const isHidden = input.type === "password";
        input.type = isHidden ? "text" : "password";

        // toggle icon
        const icon = btn.querySelector("i");
        if (icon) {
          icon.classList.toggle("fa-eye");
          icon.classList.toggle("fa-eye-slash");
        }

        // debugging trace - comment out later if you want
        console.log(`Toggled ${targetId} -> now type="${input.type}"`);
      });
    });

    // Optional: prevent form submit if passwords don't match (client-side convenience)
    const form = document.getElementById("resetPasswordForm");
    form.addEventListener("submit", (e) => {
      const p1 = document.getElementById("newPassword").value;
      const p2 = document.getElementById("confirmPassword").value;
      if (p1 !== p2) {
        e.preventDefault();
        alert("Passwords do not match.");
      }
    });
  })();
</script>

<style>
  .form_body {
    background-color: #f1f1f1;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 7px 15px rgba(113, 113, 113, 0.2);
  }
  .pw-toggle-btn i {
    color: #555;
    font-size: 18px;
  }
  .pw-toggle-btn:focus {
    outline: none;
  }
</style>
